# Development docker-compose - mirrors production as closely as possible
#
# USAGE:
#   1. Clone prod DB:    make dev-clone-db
#   2. Start containers: make dev-up
#   3. Watch logs:       make dev-logs
#   4. Run validation:   make dev-validate
#   5. Stop containers:  make dev-down
#
# HOT RELOAD:
#   - Use PROFILE=hotreload for live source code mounting
#   - Changes to TypeScript files trigger automatic restart via nodemon
#
# AI CREDENTIALS:
#   Set these in .env.dev:
#   - CLAUDE_CODE_OAUTH_TOKEN: Claude CLI OAuth token
#   - GOOGLE_API_KEY or GEMINI_API_KEY: Gemini API key
#
# DIRECTORY STRUCTURE (all gitignored):
#   .dev/
#   ├── data/              # SQLite database (cloned from prod)
#   │   └── jobfinder.db
#   ├── artifacts/         # Generated PDFs and assets
#   ├── logs/              # Container logs
#   └── output/            # Validation test output

name: job-finder-api-dev

x-api-env: &api-env
  NODE_ENV: development
  CHROMIUM_PATH: /usr/bin/chromium
  PORT: 8080
  DATABASE_PATH: /data/sqlite/jobfinder.db
  JF_SQLITE_MIGRATIONS_DIR: /app/infra/sqlite/migrations
  GENERATOR_ARTIFACTS_DIR: /data/artifacts
  GENERATOR_ARTIFACTS_PUBLIC_BASE: ${GENERATOR_ARTIFACTS_PUBLIC_BASE:-http://localhost:${API_PORT:-18080}/api/generator/artifacts}
  GENERATOR_ASSETS_DIR: /data/artifacts/assets

services:
  sqlite-migrator:
    image: ghcr.io/jdubz/job-finder-worker/api:latest
    user: "1000:1000"
    entrypoint: ["node"]
    env_file:
      - .env.dev
    environment:
      <<: *api-env
      NODE_ENV: production
    command: ["dist/scripts/migrate.js"]
    volumes:
      - type: bind
        source: ./.dev/data
        target: /data/sqlite
      - type: bind
        source: ../../infra/sqlite/migrations
        target: /app/infra/sqlite/migrations
    profiles: ["prod", "hotreload"]

  api:
    image: ghcr.io/jdubz/job-finder-worker/api:latest
    container_name: job-finder-api-dev
    user: "root"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        chown -R node:node /data 2>/dev/null || true
        exec gosu node node dist/index.js
    env_file:
      - .env.dev
    environment:
      <<: *api-env
    ports:
      - "${API_PORT:-18080}:8080"
    volumes:
      - type: bind
        source: ./.dev/data
        target: /data/sqlite
      - type: bind
        source: ./.dev/artifacts # generated PDFs stored on host
        target: /data/artifacts
      - type: bind
        source: ./.dev/logs
        target: /srv/job-finder/logs
    depends_on:
      sqlite-migrator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3
    profiles: ["prod"]

  api-hotreload:
    build:
      context: ../..
      dockerfile: job-finder-BE/server/Dockerfile
      target: base
    container_name: job-finder-api-dev-hotreload
    user: "root"
    working_dir: /app
    command:
      ["/bin/sh", "-c",
        "chown -R node:node /data 2>/dev/null || true && exec gosu node npm run dev"
      ]
    env_file:
      - .env.dev
    environment:
      <<: *api-env
      NODE_ENV: development
    ports:
      - "${API_PORT:-18080}:8080"
    volumes:
      # Source code - mounted for hot reload
      - type: bind
        source: ./src
        target: /app/src
      - type: bind
        source: ../../shared
        target: /app/shared
      - type: bind
        source: ../../infra/sqlite/migrations
        target: /app/infra/sqlite/migrations
      - type: bind
        source: ./.dev/data
        target: /data/sqlite
      - type: bind
        source: ./.dev/artifacts
        target: /data/artifacts
      - type: bind
        source: ./.dev/logs
        target: /srv/job-finder/logs
    depends_on:
      sqlite-migrator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3
    profiles: ["hotreload"]

networks:
  default:
    name: job-finder-api-dev
