# Development docker-compose - mirrors production as closely as possible
#
# USAGE:
#   1. Clone prod DB:    make dev-clone-db
#   2. Start containers: make dev-up
#   3. Watch logs:       make dev-logs
#   4. Run tests:        make dev-test-queue
#   5. Stop containers:  make dev-down
#
# HOT RELOAD:
#   - Source code is mounted from ./src to /app/src
#   - watchdog monitors for file changes and restarts the worker
#   - Changes to Python files trigger automatic restart
#
# AI INFERENCE:
#   All AI calls route through LiteLLM proxy (started automatically).
#   LiteLLM config: ../infra/litellm-config.yaml
#   Ollama runs as a Docker service; model is pulled on first start.
#
# DIRECTORY STRUCTURE (all gitignored):
#   .dev/
#   ├── data/              # SQLite database (cloned from prod)
#   │   └── jobfinder.db
#   ├── config/            # Configuration files
#   ├── logs/              # Worker logs
#   └── worker-data/       # Temp worker data

services:
  ollama:
    image: ollama/ollama:latest
    container_name: job-finder-ollama-dev
    restart: unless-stopped
    volumes:
      - ollama-models:/root/.ollama
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 3
    networks:
      - jobfinder-dev

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: job-finder-litellm-dev
    restart: unless-stopped
    depends_on:
      ollama:
        condition: service_healthy
    ports:
      - "4000:4000"
    volumes:
      - type: bind
        source: ../infra/litellm-config.dev.yaml
        target: /app/config.yaml
        read_only: true
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-dev-master-key}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    command: ["--config", "/app/config.yaml", "--port", "4000"]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/readiness')"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3
    networks:
      - jobfinder-dev

  worker:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: job-finder-worker-dev
    restart: unless-stopped
    depends_on:
      litellm:
        condition: service_healthy
    env_file:
      - .env
    environment:
      ENVIRONMENT: development
      FLASK_ENV: development
      ENABLE_QUEUE_MODE: "true"
      ENABLE_FLASK_WORKER: "true"
      ENABLE_HOT_RELOAD: "true"
      SQLITE_DB_PATH: /data/sqlite/jobfinder.db
      WORKER_PORT: "5555"
      WORKER_HOST: "0.0.0.0"
      POLL_INTERVAL: "10"  # Faster polling for dev
      LOG_LEVEL: DEBUG
      PYTHONUNBUFFERED: "1"
      LITELLM_BASE_URL: http://litellm:4000
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-dev-master-key}
      # Optional: set to lower thresholds for testing
      # MIN_MATCH_SCORE: "50"
    ports:
      - "5555:5555"
    volumes:
      # Source code - mounted for hot reload
      - type: bind
        source: ./src
        target: /app/src
      # Scripts - mounted for testing
      - type: bind
        source: ./scripts
        target: /app/scripts
      # Database - local dev copy (cloned from prod)
      - type: bind
        source: ./.dev/data
        target: /data/sqlite
      # Configuration - local dev copy
      - type: bind
        source: ./.dev/config
        target: /app/config
      # Logs - local for inspection
      - type: bind
        source: ./.dev/logs
        target: /app/logs
      # Worker temp data
      - type: bind
        source: ./.dev/worker-data
        target: /app/data
      # Test harness scripts
      - type: bind
        source: ./dev
        target: /app/dev
      # Tests - mount to run live from host
      - type: bind
        source: ./tests
        target: /app/tests
      # Share migrations from monorepo infra so tests can apply schema without duplication
      - type: bind
        source: ../infra/sqlite
        target: /app/infra/sqlite
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/health"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3
    networks:
      - jobfinder-dev

volumes:
  ollama-models:

networks:
  jobfinder-dev:
    driver: bridge
