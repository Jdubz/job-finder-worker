# Development Dockerfile - optimized for rapid development with hot reload
#
# Features:
# - watchdog for file change detection and auto-restart
# - Full Python dependencies including test/dev tools
# - Volume mounts override code for live editing
# - Debug-friendly environment variables
#
# Stage 1: build Codex CLI and Gemini CLI without leaving npm in final image
FROM node:20-slim AS cli-builder
RUN npm install -g @openai/codex@0.58.0 @google/gemini-cli@0.18.4

# Stage 2: runtime image
FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install runtime dependencies and development tools (sqlite3 for agent review)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    gcc \
    procps \
    curl \
    vim \
    sqlite3 \
    gosu \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user matching API container (node user, uid 1000)
# This ensures codex session files have consistent ownership across containers
RUN groupadd --gid 1000 node \
    && useradd --uid 1000 --gid node --shell /bin/bash --create-home node

# AI CLI config directories (mount from host for auth credentials)
ENV CODEX_HOME=/home/node/.codex
ENV GEMINI_HOME=/home/node/.gemini

# Copy Codex CLI + node runtime from builder (no npm in final image)
# Must recreate symlink as COPY dereferences it
COPY --from=cli-builder /usr/local/bin/node /usr/local/bin/node
COPY --from=cli-builder /usr/local/lib/node_modules/@openai/codex /usr/local/lib/node_modules/@openai/codex
COPY --from=cli-builder /usr/local/lib/node_modules/@openai/codex/vendor /usr/local/vendor
RUN ln -sf /usr/local/lib/node_modules/@openai/codex/bin/codex.js /usr/local/bin/codex

# Copy Gemini CLI (must recreate symlink as COPY breaks it)
COPY --from=cli-builder /usr/local/lib/node_modules/@google/gemini-cli /usr/local/lib/node_modules/@google/gemini-cli
RUN ln -sf /usr/local/lib/node_modules/@google/gemini-cli/dist/index.js /usr/local/bin/gemini

# Create directories for AI CLIs with proper ownership
RUN mkdir -p /home/node/.codex /home/node/.gemini /data/sqlite \
    && chown -R node:node /home/node/.codex /home/node/.gemini /data

# Copy and install Python dependencies first (for layer caching)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install watchdog for hot reload
RUN pip install --no-cache-dir watchdog[watchmedo]

# Copy application code (will be overridden by volume mounts in docker-compose)
COPY . .

# Create directories for dev data with proper ownership
RUN mkdir -p /app/data /app/logs /app/dev /data/sqlite \
    && chown -R node:node /app /data

# Set Python environment variables for development
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app/src:/app \
    FLASK_ENV=development \
    LOG_LEVEL=DEBUG

# Copy entrypoint script for hot reload
COPY docker/entrypoint.dev.sh /app/entrypoint.dev.sh
RUN chmod +x /app/entrypoint.dev.sh \
    && chown node:node /app/entrypoint.dev.sh

# Expose worker port
EXPOSE 5555

# Use dev entrypoint with hot reload
ENTRYPOINT ["/app/entrypoint.dev.sh"]
