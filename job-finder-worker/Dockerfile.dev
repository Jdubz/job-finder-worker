# Development Dockerfile - optimized for rapid development with hot reload
#
# Features:
# - watchdog for file change detection and auto-restart
# - Full Python dependencies including test/dev tools
# - Volume mounts override code for live editing
# - Debug-friendly environment variables
# - AI inference routes through LiteLLM proxy
#
FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install runtime dependencies and development tools (sorted alphabetically)
# Includes Chromium dependencies for Playwright JS rendering
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    fonts-liberation \
    gcc \
    gosu \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libnspr4 \
    libnss3 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxkbcommon0 \
    libxrandr2 \
    libxshmfence1 \
    procps \
    sqlite3 \
    vim \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user matching API container (node user, uid 1000)
RUN groupadd --gid 1000 node \
    && useradd --uid 1000 --gid node --shell /bin/bash --create-home node

# Create directories with proper ownership
RUN mkdir -p /home/node/.cache /data/sqlite \
    && chown -R node:node /home/node/.cache /data

# Copy and install Python dependencies + Playwright browser + watchdog
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    playwright install chromium && \
    pip install --no-cache-dir watchdog[watchmedo] && \
    # Move Playwright browser cache to node user's home and fix permissions
    mv /root/.cache/ms-playwright /home/node/.cache/ms-playwright && \
    chown -R node:node /home/node/.cache/ms-playwright

# Copy application code (will be overridden by volume mounts in docker-compose)
COPY . .

# Create directories for dev data with proper ownership
RUN mkdir -p /app/data /app/logs /app/dev /data/sqlite \
    && chown -R node:node /app /data

# Set Python environment variables for development
# PYTHONPATH is set dynamically in entrypoint.dev.sh to avoid hardcoding Python version
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    FLASK_ENV=development \
    LOG_LEVEL=DEBUG \
    PLAYWRIGHT_BROWSERS_PATH=/home/node/.cache/ms-playwright

# Copy entrypoint script for hot reload
COPY docker/entrypoint.dev.sh /app/entrypoint.dev.sh
RUN chmod +x /app/entrypoint.dev.sh \
    && chown node:node /app/entrypoint.dev.sh

# Expose worker port
EXPOSE 5555

# Use dev entrypoint with hot reload
ENTRYPOINT ["/app/entrypoint.dev.sh"]
