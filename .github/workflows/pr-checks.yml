name: Pull Request Checks

on:
  pull_request:
    branches: [main]

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Documentation checks
  docs-audit:
    name: Documentation Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run docs:audit

  # Frontend linting
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run lint:frontend

  # Backend linting
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run lint:server

  # Frontend TypeScript type checking
  frontend-typecheck:
    name: Frontend TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Build shared types
        run: npm run build:shared
      - name: TypeScript check
        working-directory: job-finder-FE
        run: npx tsc --noEmit

  # Backend TypeScript type checking
  backend-typecheck:
    name: Backend TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Build shared types
        run: npm run build:shared
      - name: TypeScript check
        working-directory: job-finder-BE/server
        run: npx tsc --noEmit

  # Frontend build
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Build frontend
        env:
          VITE_GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.VITE_GOOGLE_OAUTH_CLIENT_ID || 'test-client-id-for-ci' }}
          VITE_API_BASE_URL: http://localhost:8080
        run: npm run build:frontend

  # Backend build
  backend-build:
    name: Backend Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Build backend
        run: npm run build:server

  # Frontend unit tests
  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run unit tests
        env:
          VITE_GOOGLE_OAUTH_CLIENT_ID: test-client-id
          VITE_API_BASE_URL: http://localhost:8080
        run: npm run test:unit --workspace job-finder-FE

  # Frontend integration tests
  frontend-integration-tests:
    name: Frontend Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run integration tests
        env:
          VITE_GOOGLE_OAUTH_CLIENT_ID: test-client-id
          VITE_API_BASE_URL: http://localhost:8080
        run: npm run test:integration --workspace job-finder-FE

  # Backend unit tests
  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run unit tests
        working-directory: job-finder-BE/server
        run: npm run test

  # Worker unit tests
  worker-unit-tests:
    name: Worker Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Python dependencies
        working-directory: job-finder-worker
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-test.txt
      - name: Run pytest
        working-directory: job-finder-worker
        env:
          PYTHONPATH: src
        run: |
          pytest \
            tests/test_search_orchestrator.py \
            tests/test_placeholder.py \
            tests/queue/test_job_pipeline_comprehensive.py \
            tests/queue/test_scraper_intake.py

  # Worker Python linting - Black
  worker-black:
    name: Worker Black (formatter)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Black
        working-directory: job-finder-worker
        run: pip install black
      - name: Run Black check
        working-directory: job-finder-worker
        run: black --check src tests

  # Worker Python linting - Flake8
  worker-flake8:
    name: Worker Flake8 (linter)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Flake8
        working-directory: job-finder-worker
        run: pip install flake8
      - name: Run Flake8
        working-directory: job-finder-worker
        run: flake8 src tests

  # Worker Python type checking - MyPy
  worker-mypy:
    name: Worker MyPy (type checking)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        working-directory: job-finder-worker
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-test.txt
      - name: Run MyPy
        working-directory: job-finder-worker
        run: mypy src --ignore-missing-imports

  # Playwright E2E tests
  playwright-e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Run Playwright tests
        env:
          CI: true
        run: npm run test:e2e --workspace job-finder-FE
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: job-finder-FE/playwright-report/
          retention-days: 30
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: job-finder-FE/test-results/
          retention-days: 7

  # Vitest E2E integration tests
  vitest-e2e:
    name: Vitest Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run Vitest e2e tests
        env:
          NODE_ENV: test
        run: npm run test:e2e
