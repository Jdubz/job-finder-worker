version: "3.9"

# Template for production deployment stack (API + worker + SQLite)
#
# INSTRUCTIONS FOR PRODUCTION:
# 1. Copy this file to your production server (e.g., /srv/job-finder/docker-compose.yml)
# 2. Update the volume paths to match your server setup
# 3. Ensure all required directories exist on the host
# 4. Update the .env file with production secrets
# 5. Copy your ~/.codex folder to ./codex-seed/.codex (seed copy, read-only in containers)
#    and your ~/.gemini folder to ./gemini-seed/.gemini
# 6. Containers will copy from the seed into an internal named volume on first start,
#    avoiding root-owned host writes while still allowing token refresh.
# 7. Run: docker compose up -d
#
# AI CLI CREDENTIALS:
# - Both API and worker containers share the same ./codex and ./gemini directories
# - Mount targets are /home/node/.codex and /home/node/.gemini (containers run as node user, uid 1000)
# - The mounts must be read-write so OAuth tokens can be refreshed
# - Session files will be owned by uid 1000 to prevent host lockout

services:
  api:
    image: ghcr.io/jdubz/job-finder-worker/api:latest
    container_name: job-finder-api
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_PATH: /data/sqlite/jobfinder.db
      JF_SQLITE_MIGRATIONS_DIR: /app/infra/sqlite/migrations
      WORKER_WS_TOKEN: ${WORKER_WS_TOKEN}
      TZ: America/Los_Angeles
      LOG_DIR: /logs
      WORKER_MAINTENANCE_URL: http://worker:5555/maintenance
      # CORS_ALLOWED_ORIGINS: "https://your-frontend-domain.com,https://another-domain.com"
    volumes:
      # Update these paths to match your production server
      - type: bind
        source: ./data  # Change to your data directory
        target: /data/sqlite
      - type: bind
        source: ./artifacts  # Change to your artifacts directory
        target: /data/artifacts
      - type: bind
        source: ./logs  # Shared logs directory for rotation
        target: /logs
      # Codex: seed (ro) + named volume (rw) to prevent host permission issues
      - type: bind
        source: ./codex-seed/.codex
        target: /codex-seed
        read_only: true
      - codex-home-api:/home/node/.codex
      # Gemini: seed (ro) + named volume (rw)
      - type: bind
        source: ./gemini-seed/.gemini
        target: /gemini-seed
        read_only: true
      - gemini-home-api:/home/node/.gemini
    extra_hosts:
      # TEMP: Force IPv4 for ChatGPT domains to avoid IPv6 edge/network issues seen in prod.
      # TODO(JIRA-1234): Remove once upstream networking is stable; monitor Codex connectivity weekly.
      # Uses overridable env for visibility so ops can adjust without code changes.
      - "chatgpt.com:${CHATGPT_IPV4:-104.18.32.47}"
      - "www.chatgpt.com:${CHATGPT_IPV4:-104.18.32.47}"
    networks:
      - jobfinder
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  worker:
    image: ghcr.io/jdubz/job-finder-worker/worker:latest
    container_name: job-finder-worker
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      ENVIRONMENT: production
      ENABLE_QUEUE_MODE: "true"
      ENABLE_CRON: "false"  # Cron now runs in API container
      ENABLE_CLOUD_LOGGING: "false"
      SQLITE_DB_PATH: /data/sqlite/jobfinder.db
      JF_NODE_API_BASE: http://api:8080/api
      JF_NODE_API_TOKEN: ${WORKER_WS_TOKEN}
      JF_WORKER_WS_TOKEN: ${WORKER_WS_TOKEN}
      JF_WORKER_ID: default
      TZ: America/Los_Angeles
    volumes:
      # Update these paths to match your production server
      - type: bind
        source: ./data  # Change to your data directory
        target: /data/sqlite
      - type: bind
        source: ./logs  # Change to your logs directory
        target: /app/logs
      # Codex: seed (ro) + named volume (rw) to prevent host permission issues
      - type: bind
        source: ./codex-seed/.codex
        target: /codex-seed
        read_only: true
      - codex-home-worker:/home/node/.codex
      # Gemini: seed (ro) + named volume (rw)
      - type: bind
        source: ./gemini-seed/.gemini
        target: /gemini-seed
        read_only: true
      - gemini-home-worker:/home/node/.gemini
    networks:
      - jobfinder
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  cloudflared:
    image: cloudflare/cloudflared:2024.10.0
    container_name: job-finder-cloudflared
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    env_file:
      - ../.env
    environment:
      TUNNEL_ORIGIN_CERT: /etc/cloudflared/cert.pem
    depends_on:
      - api
volumes:
  codex-home-api:
  codex-home-worker:
  gemini-home-api:
  gemini-home-worker:
      # Update this path to your cloudflared config directory
      - type: bind
        source: ./cloudflared  # Change to your cloudflared directory
        target: /etc/cloudflared
        read_only: true
    networks:
      - jobfinder
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: job-finder-watchtower
    restart: unless-stopped
    command: --label-enable --interval 300 --cleanup
    environment:
      TZ: America/Los_Angeles
      DOCKER_API_VERSION: 1.44
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - jobfinder

networks:
  jobfinder:
    driver: bridge
