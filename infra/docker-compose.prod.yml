# =============================================================================
# PRODUCTION DOCKER COMPOSE - Job Finder
# =============================================================================
#
# DEPLOY ARCHITECTURE:
# --------------------
# 1. CI builds Docker images and pushes to GHCR (github.com/jdubz/job-finder-worker)
# 2. Watchtower (running here) detects new images and recreates containers
# 3. This compose file lives at /srv/job-finder/docker-compose.yml
#
# WHEN TO SYNC THIS FILE:
# -----------------------
# After changing infra/docker-compose.prod.yml, run:
#   ./scripts/deploy.sh --recreate
#
# This copies the file to /srv/job-finder/ and recreates containers.
# Watchtower only handles IMAGE updates, not compose file changes.
#
# AI INFERENCE:
# -------------
# All AI calls route through the LiteLLM proxy (litellm:4000).
# Model routing (claude-document, gemini-general, local-extract)
# is configured in infra/litellm-config.yaml.
#
# Set LITELLM_MASTER_KEY in the host environment or secrets/*.env.
# Provider API keys (ANTHROPIC_API_KEY, GEMINI_API_KEY) go in secrets/worker.env.
#
# PRODUCTION PATHS:
# -----------------
# /srv/job-finder/
#   ├── docker-compose.yml    <- This file (synced from repo)
#   ├── data/                  <- SQLite database
#   ├── artifacts/             <- Generated documents (resumes, cover letters)
#   ├── logs/                  <- Application logs
#   ├── secrets/               <- api.env, worker.env
#   └── cloudflared/           <- Tunnel config
#
# =============================================================================

services:
  api:
    image: ghcr.io/jdubz/job-finder-worker/api:latest
    container_name: job-finder-api
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      # Expose API on LAN for job-applicator desktop app (auth bypassed for private IPs)
      - "0.0.0.0:3000:8080"
    env_file:
      - /srv/job-finder/secrets/api.env
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_PATH: /data/sqlite/jobfinder.db
      JF_SQLITE_MIGRATIONS_DIR: /app/infra/sqlite/migrations
      LOG_DIR: /logs
      WORKER_URL: http://worker:5555
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-https://job-finder.joshwentworth.com}
      TZ: America/Los_Angeles
      LITELLM_BASE_URL: http://litellm:4000
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      # Firebase Admin SDK (auth)
      GOOGLE_APPLICATION_CREDENTIALS: /secrets/firebase-admin.json
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
    depends_on:
      litellm:
        condition: service_healthy
    volumes:
      - type: bind
        source: /srv/job-finder/data
        target: /data/sqlite
      - type: bind
        source: /srv/job-finder/artifacts
        target: /data/artifacts
      - type: bind
        source: /srv/job-finder/logs
        target: /logs
      # Firebase Admin SDK (auth)
      - type: bind
        source: /srv/job-finder/secrets/firebase-admin.json
        target: /secrets/firebase-admin.json
        read_only: true
    networks:
      - jobfinder
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  worker:
    image: ghcr.io/jdubz/job-finder-worker/worker:latest
    container_name: job-finder-worker
    restart: unless-stopped
    env_file:
      - /srv/job-finder/secrets/worker.env
    environment:
      ENVIRONMENT: production
      ENABLE_QUEUE_MODE: "true"
      ENABLE_CLOUD_LOGGING: "false"
      SQLITE_DB_PATH: /data/sqlite/jobfinder.db
      JF_NODE_API_BASE: http://api:8080/api
      JF_WORKER_ID: default
      TZ: America/Los_Angeles
      LITELLM_BASE_URL: http://litellm:4000
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      GOOGLE_APPLICATION_CREDENTIALS: /secrets/firebase-admin.json
    depends_on:
      litellm:
        condition: service_healthy
    volumes:
      - type: bind
        source: /srv/job-finder/data
        target: /data/sqlite
      - type: bind
        source: /srv/job-finder/logs
        target: /app/logs
      # Firebase Admin SDK (auth)
      - type: bind
        source: /srv/job-finder/secrets/firebase-admin.json
        target: /secrets/firebase-admin.json
        read_only: true
    networks:
      - jobfinder
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: job-finder-litellm
    restart: unless-stopped
    ports:
      - "4000:4000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/readiness')"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3
    env_file:
      - /srv/job-finder/secrets/worker.env  # ANTHROPIC_API_KEY, GEMINI_API_KEY
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      TZ: America/Los_Angeles
    volumes:
      - ./infra/litellm-config.yaml:/app/config.yaml
    command: ["--config", "/app/config.yaml", "--port", "4000"]
    networks:
      - jobfinder
    # No watchtower label — LiteLLM updates should be deliberate, not automatic.
    # To update: docker compose pull litellm && docker compose up -d litellm

  cloudflared:
    image: cloudflare/cloudflared:2024.10.0
    container_name: job-finder-cloudflared
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    environment:
      TUNNEL_ORIGIN_CERT: /etc/cloudflared/cert.pem
    depends_on:
      - api
    volumes:
      - type: bind
        source: /srv/job-finder/cloudflared
        target: /etc/cloudflared
        read_only: true
    networks:
      - jobfinder
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: job-finder-watchtower
    restart: unless-stopped
    command: --label-enable --interval 300 --cleanup
    environment:
      TZ: America/Los_Angeles
      DOCKER_API_VERSION: 1.44
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - jobfinder

  stack-guard:
    image: docker:26-cli
    container_name: job-finder-stack-guard
    restart: unless-stopped
    command: >
      sh -c '
        echo "[stack-guard] monitoring stopped containers with watchtower label";
        while :; do
          stopped=$(docker ps -a --filter "label=com.centurylinklabs.watchtower.enable=true" --filter "status=exited" --format "{{.Names}}");
          if [ -n "$stopped" ]; then
            echo "[stack-guard] restarting: $stopped";
            echo "$stopped" | xargs -r docker start;
          fi;
          sleep ${STACK_GUARD_INTERVAL:-30};
        done
      '
    environment:
      STACK_GUARD_INTERVAL: 30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - jobfinder

networks:
  jobfinder:
    driver: bridge

volumes: {}
